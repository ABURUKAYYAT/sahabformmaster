<?php
session_start();
require_once '../config/db.php';
require_once '../includes/functions.php';
require_once '../TCPDF-main/TCPDF-main/tcpdf.php';

// Check if teacher is logged in
if (!isset($_SESSION['user_id']) || $_SESSION['role'] !== 'teacher') {
    header("Location: ../index.php");
    exit;
}

// School authentication and context
$current_school_id = require_school_auth();

$teacher_id = $_SESSION['user_id'];
$teacher_name = $_SESSION['full_name'];

// Fetch school profile - filtered by school_id
$stmt = $pdo->prepare("SELECT * FROM school_profile WHERE school_id = ?");
$stmt->execute([$current_school_id]);
$school = $stmt->fetch(PDO::FETCH_ASSOC);

// Fetch evaluations created by this teacher - filtered by school
$stmt = $pdo->prepare("
    SELECT e.*, s.full_name, s.class_id, s.admission_no, c.class_name
    FROM evaluations e
    JOIN students s ON e.student_id = s.id
    JOIN classes c ON e.class_id = c.id
    WHERE e.teacher_id = ? AND s.school_id = ? AND c.school_id = ?
    ORDER BY c.class_name, s.full_name, e.term DESC, e.academic_year DESC
");
$stmt->execute([$teacher_id, $current_school_id, $current_school_id]);
$evaluations = $stmt->fetchAll();

// Calculate statistics
$total_evaluations = count($evaluations);
$excellent_count = 0;
$very_good_count = 0;
$good_count = 0;
$needs_improvement_count = 0;

foreach ($evaluations as $eval) {
    if (in_array('excellent', [$eval['academic'], $eval['non_academic'], $eval['cognitive'], $eval['psychomotor'], $eval['affective']])) {
        $excellent_count++;
    }
    if (in_array('very-good', [$eval['academic'], $eval['non_academic'], $eval['cognitive'], $eval['psychomotor'], $eval['affective']])) {
        $very_good_count++;
    }
    if (in_array('good', [$eval['academic'], $eval['non_academic'], $eval['cognitive'], $eval['psychomotor'], $eval['affective']])) {
        $good_count++;
    }
    if (in_array('needs-improvement', [$eval['academic'], $eval['non_academic'], $eval['cognitive'], $eval['psychomotor'], $eval['affective']])) {
        $needs_improvement_count++;
    }
}

// Extend TCPDF class for custom header/footer
class StudentEvaluationsPDF extends TCPDF {

    private $school;
    private $teacher_name;
    private $total_evaluations;

    public function __construct($school, $teacher_name, $total_evaluations) {
        parent::__construct();
        $this->school = $school;
        $this->teacher_name = $teacher_name;
        $this->total_evaluations = $total_evaluations;
    }

    // Page header
    public function Header() {
        // School logo
        if (!empty($this->school['school_logo']) && file_exists('../' . $this->school['school_logo'])) {
            $this->Image('../' . $this->school['school_logo'], 15, 10, 25, 25, '', '', '', false, 300, '', false, false, 0);
        }

        // School name and motto
        $this->SetFont('helvetica', 'B', 16);
        $this->SetXY(45, 12);
        $this->Cell(0, 8, strtoupper($this->school['school_name']), 0, 1, 'L');

        if (!empty($this->school['school_motto'])) {
            $this->SetFont('helvetica', 'I', 12);
            $this->SetXY(45, 20);
            $this->Cell(0, 6, $this->school['school_motto'], 0, 1, 'L');
        }

        // Address and contact
        $this->SetFont('helvetica', '', 9);
        $this->SetXY(45, 26);
        $this->Cell(0, 5, $this->school['school_address'], 0, 1, 'L');

        // Decorative line
        $this->SetLineWidth(0.5);
        $this->Line(15, 35, 195, 35);

        // Document title
        $this->SetFont('helvetica', 'B', 14);
        $this->SetXY(15, 40);
        $this->Cell(0, 8, 'STUDENT EVALUATIONS REPORT', 0, 1, 'C');

        // Report information box
        $this->SetLineWidth(0.3);
        $this->Rect(15, 50, 180, 20);

        $this->SetFont('helvetica', '', 10);
        $this->SetXY(17, 52);
        $this->Cell(40, 5, 'Generated by:', 0, 0, 'L');
        $this->Cell(50, 5, $this->teacher_name, 0, 0, 'L');
        $this->Cell(30, 5, 'Date:', 0, 0, 'L');
        $this->Cell(0, 5, date('F j, Y'), 0, 1, 'L');

        $this->SetXY(17, 58);
        $this->Cell(40, 5, 'Total Evaluations:', 0, 0, 'L');
        $this->Cell(50, 5, $this->total_evaluations, 0, 0, 'L');
        $this->Cell(30, 5, 'Time:', 0, 0, 'L');
        $this->Cell(0, 5, date('H:i:s'), 0, 1, 'L');

        $this->SetY(75);
    }

    // Page footer
    public function Footer() {
        $this->SetY(-25);

        // Signature lines
        $this->SetFont('helvetica', '', 9);
        $this->SetXY(15, -20);
        $this->Cell(60, 5, '_______________________________', 0, 0, 'C');
        $this->Cell(60, 5, '_______________________________', 0, 0, 'C');
        $this->Cell(60, 5, '_______________________________', 0, 1, 'C');

        $this->SetXY(15, -15);
        $this->Cell(60, 5, 'Teacher', 0, 0, 'C');
        $this->Cell(60, 5, 'Principal', 0, 0, 'C');
        $this->Cell(60, 5, 'School Stamp', 0, 1, 'C');

        // Page number
        $this->SetFont('helvetica', 'I', 8);
        $this->Cell(0, 10, 'Page ' . $this->getAliasNumPage() . '/' . $this->getAliasNbPages(), 0, 0, 'C');
    }
}

// Create PDF instance
$pdf = new StudentEvaluationsPDF($school, $teacher_name, $total_evaluations);

// Set document information
$pdf->SetCreator('SahabFormMaster School Management System');
$pdf->SetAuthor($school['school_name']);
$pdf->SetTitle('Student Evaluations Report - ' . $teacher_name);
$pdf->SetSubject('Comprehensive Student Evaluations Report');

// Set margins
$pdf->SetMargins(15, 80, 15); // Left, Top, Right
$pdf->SetHeaderMargin(5);
$pdf->SetFooterMargin(30);

// Set auto page breaks
$pdf->SetAutoPageBreak(TRUE, 35);

// Add first page
$pdf->AddPage();

// Summary Statistics Section
$pdf->SetFont('helvetica', 'B', 12);
$pdf->Cell(0, 10, 'EVALUATION SUMMARY STATISTICS', 0, 1, 'L');

$pdf->SetFont('helvetica', '', 10);
$pdf->SetFillColor(240, 240, 240);

// Statistics table
$stats_data = [
    ['Total Evaluations', $total_evaluations],
    ['Excellent Ratings', $excellent_count],
    ['Very Good Ratings', $very_good_count],
    ['Good Ratings', $good_count],
    ['Needs Improvement', $needs_improvement_count]
];

foreach ($stats_data as $stat) {
    $pdf->Cell(120, 8, $stat[0] . ':', 'LR', 0, 'L', true);
    $pdf->Cell(20, 8, $stat[1], 'R', 1, 'C', true);
}

$pdf->Ln(10);

// Evaluations Table Section
$pdf->SetFont('helvetica', 'B', 12);
$pdf->Cell(0, 10, 'STUDENT EVALUATIONS DETAILS', 0, 1, 'L');

// Table headers
$pdf->SetFont('helvetica', 'B', 8);
$pdf->SetFillColor(59, 130, 246); // Blue header
$pdf->SetTextColor(255, 255, 255);

$header_widths = [8, 35, 25, 15, 20, 20, 20, 20, 20];
$headers = ['S/N', 'Student Name', 'Class', 'Term/Year', 'Academic', 'Non-Acad', 'Cognitive', 'Psychomotor', 'Affective'];

foreach ($headers as $i => $header) {
    $pdf->Cell($header_widths[$i], 10, $header, 1, 0, 'C', true);
}
$pdf->Ln();

// Table data
$pdf->SetFont('helvetica', '', 7);
$pdf->SetTextColor(0, 0, 0);
$pdf->SetFillColor(248, 250, 252);

$fill = false;
$counter = 1;

foreach ($evaluations as $eval) {
    $pdf->SetFillColor($fill ? 248 : 255, $fill ? 250 : 255, $fill ? 252 : 255);

    $pdf->Cell(8, 8, $counter++, 1, 0, 'C', $fill);

    // Student name (truncated if too long)
    $student_name = strlen($eval['full_name']) > 20 ? substr($eval['full_name'], 0, 17) . '...' : $eval['full_name'];
    $pdf->Cell(35, 8, $student_name, 1, 0, 'L', $fill);

    $pdf->Cell(25, 8, $eval['class_name'], 1, 0, 'L', $fill);
    $pdf->Cell(15, 8, 'Term ' . $eval['term'] . '/' . substr($eval['academic_year'], -2), 1, 0, 'C', $fill);

    // Rating cells with colors
    $ratings = ['academic', 'non_academic', 'cognitive', 'psychomotor', 'affective'];
    foreach ($ratings as $rating) {
        $rating_value = $eval[$rating];
        $color = getRatingColor($rating_value);

        $pdf->SetFillColor($color['r'], $color['g'], $color['b']);
        $pdf->SetTextColor(255, 255, 255);
        $pdf->Cell(20, 8, ucfirst(str_replace('-', ' ', $rating_value)), 1, 0, 'C', true);
        $pdf->SetTextColor(0, 0, 0);
        $pdf->SetFillColor($fill ? 248 : 255, $fill ? 250 : 255, $fill ? 252 : 255);
    }

    $pdf->Ln();
    $fill = !$fill;
}

// Comments Section (if evaluations have comments)
$comments_exist = false;
foreach ($evaluations as $eval) {
    if (!empty($eval['comments'])) {
        $comments_exist = true;
        break;
    }
}

if ($comments_exist) {
    $pdf->AddPage();
    $pdf->SetFont('helvetica', 'B', 12);
    $pdf->Cell(0, 10, 'STUDENT COMMENTS AND RECOMMENDATIONS', 0, 1, 'L');

    $pdf->SetFont('helvetica', '', 9);
    $counter = 1;

    foreach ($evaluations as $eval) {
        if (!empty($eval['comments'])) {
            $pdf->SetFont('helvetica', 'B', 9);
            $pdf->Cell(0, 8, $counter . '. ' . $eval['full_name'] . ' (' . $eval['class_name'] . ')', 0, 1, 'L');

            $pdf->SetFont('helvetica', '', 8);
            $pdf->MultiCell(0, 5, $eval['comments'], 0, 'L');
            $pdf->Ln(3);
            $counter++;
        }
    }
}

// Important notes
$pdf->Ln(10);
$pdf->SetFont('helvetica', 'B', 10);
$pdf->Cell(0, 8, 'IMPORTANT NOTES:', 0, 1, 'L');

$pdf->SetFont('helvetica', '', 8);
$notes = "• This report contains confidential student evaluation information.\n";
$notes .= "• Evaluations are based on teacher observations and assessments across multiple domains.\n";
$notes .= "• Any concerns regarding the evaluation process should be directed to the school administration.\n";
$notes .= "• This document is generated by the SahabFormMaster School Management System.";

$pdf->MultiCell(0, 4, $notes, 0, 'L');

// Generate filename and output
$safe_teacher = preg_replace('/[^A-Za-z0-9\-_]/', '_', $teacher_name);
$filename = 'Student_Evaluations_Report_' . $safe_teacher . '_' . date('Ymd_His') . '.pdf';

// Create directory if it doesn't exist
$export_dir = dirname(__DIR__) . '/exports/evaluations/';
if (!file_exists($export_dir)) {
    mkdir($export_dir, 0777, true);
}

$filepath = $export_dir . $filename;

// Save PDF file
$pdf->Output($filepath, 'F');

// Log the export (optional - skip if table doesn't exist)
try {
    $stmt = $pdo->prepare("
        INSERT INTO export_logs (user_id, export_type, file_path, exported_at, ip_address)
        VALUES (?, 'evaluations_report', ?, NOW(), ?)
    ");
    $stmt->execute([
        $teacher_id,
        $filepath,
        $_SERVER['REMOTE_ADDR'] ?? 'unknown'
    ]);
} catch (PDOException $e) {
    // Silently skip logging if export_logs table doesn't exist
}

// Output PDF to browser
header('Content-Type: application/pdf');
header('Content-Disposition: inline; filename="' . $filename . '"');
header('Content-Transfer-Encoding: binary');
header('Accept-Ranges: bytes');
header('Cache-Control: private');
readfile($filepath);
exit;

// Helper function to get rating colors for PDF
function getRatingColor($rating) {
    switch ($rating) {
        case 'excellent':
            return ['r' => 34, 'g' => 197, 'b' => 94]; // Green
        case 'very-good':
            return ['r' => 245, 'g' => 158, 'b' => 11]; // Yellow
        case 'good':
            return ['r' => 168, 'g' => 85, 'b' => 247]; // Purple
        case 'needs-improvement':
            return ['r' => 239, 'g' => 68, 'b' => 68]; // Red
        default:
            return ['r' => 156, 'g' => 163, 'b' => 175]; // Gray
    }
}
?>
